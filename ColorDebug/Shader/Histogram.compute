
#pragma kernel KHistogramClear
#pragma kernel KHistogramGather

#define HISTOGRAM_BINS 256
#define GROUP_SIZE_X 16
#define GROUP_SIZE_Y 16

// ��� ����: 256���� uint ���� �����ϴ�.
RWStructuredBuffer<uint> _HistogramBuffer;

// �Է� �ؽ�ó
Texture2D<float4> _Source;

// �Է� �Ķ����: x: width, y: height
float4 _Params;

// ������׷� ���۸� 0���� �ʱ�ȭ�ϴ� Ŀ��
[numthreads(GROUP_SIZE_X, 1, 1)]
void KHistogramClear(uint3 dispatchThreadId : SV_DispatchThreadID)
{
    if (dispatchThreadId.x < HISTOGRAM_BINS)
        _HistogramBuffer[dispatchThreadId.x] = 0u;
}

// �ؽ�ó�� �о� ������׷��� ����ϴ� Ŀ��
[numthreads(GROUP_SIZE_X, GROUP_SIZE_Y, 1)]
void KHistogramGather(uint2 dispatchThreadId : SV_DispatchThreadID)
{
    // ȭ�� �ȼ� ������ ����� �ߴ�
    if (dispatchThreadId.x >= (uint) _Params.x || dispatchThreadId.y >= (uint) _Params.y)
        return;

    // �ȼ� ���� �б�
    float3 color = _Source[dispatchThreadId].rgb;

    // �ֵ�(Luminance) ��� (sRGB, D65 ����)
    float luma = dot(color, float3(0.2126, 0.7152, 0.0722));

    // �ֵ� ���� 0-255 ������ �ε����� ��ȯ
    uint idx = (uint) (saturate(luma) * 255.0);

    // �ش� �ε����� ī��Ʈ�� 1 ���� (������ ����)
    InterlockedAdd(_HistogramBuffer[idx], 1u);
}
